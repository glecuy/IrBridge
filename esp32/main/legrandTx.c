/* LEGRAND Remote TX (raw data)
 *
 * "in One By Legrand"
 *
 * Telecommande 24 directions
 * 882 20


*/
#include <stdio.h>
#include <string.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "freertos/queue.h"
#include "freertos/semphr.h"
#include "esp_err.h"
#include "esp_log.h"
#include "driver/rmt.h"
#include "driver/periph_ctrl.h"
#include "soc/rmt_reg.h"

#include "InfraredTx.h"
#include "legrandTx.h"


#define MAX_TX_ITEM 20

typedef struct rawTxItem_s{
	uint8_t h;
	uint8_t l;
} rawTxItem_t;


typedef struct rawTxItemSeq_s{
	rawTxItem_t rawTxItems[MAX_TX_ITEM];
	uint16_t length;
	uint16_t delay;
}rawTxItemSeq_t;

/*
 * 
 *
 * The table structure represents the RMT item structure:
 * {duration, level, duration, level}
 *
 */
rmt_item32_t txIitems01[] = {
        {{{   710, 1,   320, 0 }}}, // 0
        {{{   355, 1,   313, 0 }}}, // 2
        {{{   358, 1,   313, 0 }}}, // 4
        {{{   358, 1,   988, 0 }}}, // 6
        {{{   694, 1,   649, 0 }}}, // 8
        {{{  1369, 1,   985, 0 }}}, // 10
        {{{   355, 1,   652, 0 }}}, // 12
        {{{   358, 1,  1308, 0 }}}, // 14
        {{{   371, 1,   652, 0 }}}, // 16
        {{{   358, 1,  3321, 0 }}}, // 18
        {{{   374, 1,   316, 0 }}}, // 20
        {{{  1702, 1,  1305, 0 }}}, // 22
        {{{   377, 1,   985, 0 }}}, // 24
        {{{  1702, 1,   649, 0 }}}, // 26
        {{{   697, 1,   313, 0 }}}, // 28
        {{{   358, 1,   313, 0 }}}, // 30
        {{{   694, 1,   316, 0 }}}, // 32
        {{{   358, 1, 32767, 0 }}}, // 34
        {{{ 23339, 0, 23339, 0 }}},
        {{{ 23339, 0, 23339, 0 }}},
        {{{   716, 1,   313, 0 }}}, // 36
        {{{   361, 1,   313, 0 }}}, // 38
        {{{   358, 1,   313, 0 }}}, // 40
        {{{   355, 1,   985, 0 }}}, // 42
        {{{   361, 1,   985, 0 }}}, // 44
        {{{  1369, 1,   985, 0 }}}, // 46
        {{{   358, 1,   649, 0 }}}, // 48
        {{{   361, 1,  1302, 0 }}}, // 50
        {{{   374, 1,   649, 0 }}}, // 52
        {{{   358, 1,  3324, 0 }}}, // 54
        {{{   377, 1,   313, 0 }}}, // 56
        {{{  1702, 1,  1321, 0 }}}, // 58
        {{{   358, 1,   316, 0 }}}, // 60
        {{{   694, 1,   313, 0 }}}, // 62
        {{{  1369, 1,   649, 0 }}}, // 64
        {{{  1363, 1,   652, 0 }}}, // 66
        {{{   694, 1,  1000, 0 }}}, // 68
		// RMT end marker
		{{{ 0, 1, 0, 0 }}}
	};

rmt_item32_t txIitems02[] = {
        {{{   716, 1,   316, 0 }}}, // 0
        {{{   355, 1,   316, 0 }}}, // 2
        {{{   355, 1,   316, 0 }}}, // 4
        {{{   355, 1,   988, 0 }}}, // 6
        {{{   358, 1,   985, 0 }}}, // 8
        {{{  1369, 1,   985, 0 }}}, // 10
        {{{   355, 1,   656, 0 }}}, // 12
        {{{   355, 1,  1305, 0 }}}, // 14
        {{{   374, 1,   652, 0 }}}, // 16
        {{{   358, 1,  3324, 0 }}}, // 18
        {{{   371, 1,   656, 0 }}}, // 20
        {{{  1363, 1,  1305, 0 }}}, // 22
        {{{   377, 1,   985, 0 }}}, // 24
        {{{  1702, 1,   652, 0 }}}, // 26
        {{{   691, 1,   652, 0 }}}, // 28
        {{{   358, 1,   313, 0 }}}, // 30
        {{{  1030, 1, 32767, 0 }}}, // 32
        {{{ 23341, 0, 23341, 0 }}},
        {{{ 23341, 0, 23341, 0 }}},
        {{{   713, 1,   313, 0 }}}, // 34
        {{{   358, 1,   316, 0 }}}, // 36
        {{{   358, 1,   313, 0 }}}, // 38
        {{{   358, 1,   985, 0 }}}, // 40
        {{{  1033, 1,   313, 0 }}}, // 42
        {{{  1366, 1,   988, 0 }}}, // 44
        {{{   355, 1,   652, 0 }}}, // 46
        {{{   355, 1,  1324, 0 }}}, // 48
        {{{   358, 1,   649, 0 }}}, // 50
        {{{   358, 1,  3324, 0 }}}, // 52
        {{{   377, 1,   649, 0 }}}, // 54
        {{{  1363, 1,  1324, 0 }}}, // 56
        {{{   358, 1,   313, 0 }}}, // 58
        {{{   694, 1,   316, 0 }}}, // 60
        {{{  1366, 1,   649, 0 }}}, // 62
        {{{   358, 1,   988, 0 }}}, // 64
        {{{  1027, 1,   316, 0 }}}, // 66
        {{{   355, 1,  1000, 0 }}}, // 68
		// RMT end marker
		{{{ 0, 1, 0, 0 }}}
	};

rmt_item32_t txIitems03[] = {
        {{{   713, 1,   313, 0 }}}, // 0
        {{{   358, 1,   316, 0 }}}, // 2
        {{{   358, 1,   313, 0 }}}, // 4
        {{{   358, 1,   985, 0 }}}, // 6
        {{{  1030, 1,   316, 0 }}}, // 8
        {{{  1363, 1,   988, 0 }}}, // 10
        {{{   358, 1,   649, 0 }}}, // 12
        {{{   358, 1,  1324, 0 }}}, // 14
        {{{   358, 1,   649, 0 }}}, // 16
        {{{   355, 1,  3344, 0 }}}, // 18
        {{{   358, 1,   313, 0 }}}, // 20
        {{{   358, 1,   313, 0 }}}, // 22
        {{{  1033, 1,  1305, 0 }}}, // 24
        {{{   371, 1,   992, 0 }}}, // 26
        {{{  1699, 1,   652, 0 }}}, // 28
        {{{   694, 1,   313, 0 }}}, // 30
        {{{   694, 1, 32767, 0 }}}, // 32
        {{{ 23679, 0, 23679, 0 }}},
        {{{ 23679, 0, 23679, 0 }}},
        {{{   707, 1,   320, 0 }}}, // 34
        {{{   355, 1,   316, 0 }}}, // 36
        {{{   355, 1,   313, 0 }}}, // 38
        {{{   358, 1,   988, 0 }}}, // 40
        {{{   336, 1,   336, 0 }}}, // 42
        {{{   358, 1,   313, 0 }}}, // 44
        {{{  1369, 1,   985, 0 }}}, // 46
        {{{   358, 1,   652, 0 }}}, // 48
        {{{   355, 1,  1321, 0 }}}, // 50
        {{{   358, 1,   652, 0 }}}, // 52
        {{{   358, 1,  3340, 0 }}}, // 54
        {{{   358, 1,   313, 0 }}}, // 56
        {{{   336, 1,   339, 0 }}}, // 58
        {{{  1027, 1,  1321, 0 }}}, // 60
        {{{   342, 1,   332, 0 }}}, // 62
        {{{   694, 1,   313, 0 }}}, // 64
        {{{  1366, 1,   652, 0 }}}, // 66
        {{{  2041, 1,   313, 0 }}}, // 68
        {{{   691, 1,  1000, 0 }}}, // 70
		// RMT end marker
		{{{ 0, 1, 0, 0 }}}
	};


rmt_item32_t txIitems04[] = {
        {{{   713, 1,   313, 0 }}}, // 0
        {{{   358, 1,   313, 0 }}}, // 2
        {{{   361, 1,   313, 0 }}}, // 4
        {{{   358, 1,   985, 0 }}}, // 6
        {{{  1030, 1,   313, 0 }}}, // 8
        {{{  1366, 1,   988, 0 }}}, // 10
        {{{   358, 1,   649, 0 }}}, // 12
        {{{   358, 1,  1305, 0 }}}, // 14
        {{{   374, 1,   649, 0 }}}, // 16
        {{{   358, 1,  3324, 0 }}}, // 18
        {{{   377, 1,   985, 0 }}}, // 20
        {{{  1030, 1,  1308, 0 }}}, // 22
        {{{   371, 1,   988, 0 }}}, // 24
        {{{  1705, 1,   649, 0 }}}, // 26
        {{{   355, 1,   652, 0 }}}, // 28
        {{{  1030, 1,   649, 0 }}}, // 30
        {{{   358, 1, 32767, 0 }}}, // 32
        {{{ 23345, 0, 23345, 0 }}},
        {{{ 23345, 0, 23345, 0 }}},
        {{{   713, 1,   313, 0 }}}, // 34
        {{{   358, 1,   313, 0 }}}, // 36
        {{{   358, 1,   313, 0 }}}, // 38
        {{{   358, 1,   988, 0 }}}, // 40
        {{{   358, 1,   313, 0 }}}, // 42
        {{{   355, 1,   320, 0 }}}, // 44
        {{{  1363, 1,   985, 0 }}}, // 46
        {{{   358, 1,   652, 0 }}}, // 48
        {{{   358, 1,  1305, 0 }}}, // 50
        {{{   374, 1,   652, 0 }}}, // 52
        {{{   358, 1,  3337, 0 }}}, // 54
        {{{   358, 1,   988, 0 }}}, // 56
        {{{  1030, 1,  1305, 0 }}}, // 58
        {{{   377, 1,   313, 0 }}}, // 60
        {{{   694, 1,   313, 0 }}}, // 62
        {{{  1366, 1,   649, 0 }}}, // 64
        {{{   358, 1,   313, 0 }}}, // 66
        {{{  1033, 1,   649, 0 }}}, // 68
        {{{   358, 1,  1000, 0 }}}, // 70
		// RMT end marker
		{{{ 0, 1, 0, 0 }}}
	};



rmt_item32_t * txIitems[] = {
	txIitems01,
	txIitems02,
	txIitems03,
	txIitems04
}; 


/*
 * @brief Build LEGRAND  waveform from raw data.
 */



void InfraredLegrandTxExecute( short index ){
    int nbItem;

	// Expecting "RMT end marker" shall stop TX
	nbItem = 40;
	
    //To send data according to the waveform items.
    rmt_write_items(RMT_TX_CHANNEL, txIitems[index&0x3], nbItem, true);
    //Wait until sending is done.
    rmt_wait_tx_done(RMT_TX_CHANNEL, portMAX_DELAY);   
    
}

